# Microsoft Security Response Center (MSRC) Vulnerability Report

## Report Template for SetWindowDisplayAffinity Bypass

### Executive Summary
**Title:** Kernel-Level Bypass of SetWindowDisplayAffinity Display Protection
**Product:** Windows 10/11 Kernel (Win32k.sys)
**Severity:** Medium (Local privilege required)
**CVE:** Pending assignment
**Reporter:** [Your Name/Organization]
**Date:** [Current Date]

### Vulnerability Details

#### Description
A vulnerability exists in Windows kernel that allows local administrators to bypass SetWindowDisplayAffinity protection through system call hooking. This enables screenshot capture of windows marked with WDA_EXCLUDEFROMCAPTURE flag.

#### Affected Components
- **Primary:** `win32k.sys`, `win32kbase.sys`
- **Function:** `NtUserSetWindowDisplayAffinity`
- **Versions Affected:**
  - Windows 10 (1903 - 22H2)
  - Windows 11 (21H2 - 23H2)
  - Windows Server 2019/2022

#### Attack Vector
- **Access Required:** Local Administrator / Kernel Access
- **User Interaction:** None after initial driver load
- **Scope:** System-wide (all applications affected)

### Technical Analysis

#### Root Cause
The vulnerability stems from:
1. Lack of kernel-level integrity verification for display affinity flags
2. System call table modification possible with kernel access
3. No runtime verification of hook integrity

#### Exploitation Technique
```
1. Load kernel driver (requires admin)
2. Hook NtUserSetWindowDisplayAffinity via SSDT/CKCL
3. Force dwFlags parameter to 0x00000000
4. All subsequent display protection attempts fail silently
```

#### Proof of Concept
```c
// Simplified PoC
int64_t __fastcall DetourNtUserSetWindowDisplayAffinity(HWND hwnd, DWORD dwFlags) {
    // Force flags to zero, disabling all protection
    dwFlags = 0x00000000;
    return OriginalNtUserSetWindowDisplayAffinity(hwnd, dwFlags);
}
```

### Impact Assessment

#### CVSS 3.1 Score: 6.5 (Medium)
- **Vector:** CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:N
- **Attack Vector (AV):** Local
- **Attack Complexity (AC):** Low
- **Privileges Required (PR):** High (Admin/Kernel)
- **User Interaction (UI):** None
- **Scope (S):** Unchanged
- **Confidentiality (C):** High (screenshots of protected content)
- **Integrity (I):** High (security feature bypass)
- **Availability (A):** None

#### Business Impact
- DRM content protection bypass
- Corporate data loss prevention circumvention
- Privacy protection failure
- Compliance violations (GDPR, HIPAA if medical data visible)

### Reproduction Steps

#### Environment Setup
1. Windows 10/11 x64 test machine
2. Test signing mode enabled: `bcdedit /set testsigning on`
3. Administrator privileges

#### Steps to Reproduce
1. Build the kernel driver from provided source
2. Load driver: `sc create test type=kernel binPath=driver.sys && sc start test`
3. Open application using SetWindowDisplayAffinity (Discord, Teams, etc.)
4. Take screenshot - protected content now visible

#### Expected Result
Screenshot should show black rectangle for protected windows

#### Actual Result
Protected windows fully visible in screenshots

### Mitigation Recommendations

#### Short-term Mitigations
1. Enable Hypervisor-Protected Code Integrity (HVCI)
2. Implement Windows Defender Application Control (WDAC)
3. Monitor for unsigned kernel drivers
4. Enable Secure Boot

#### Long-term Fixes
1. Implement kernel-level integrity checking for display affinity
2. Add PatchGuard protection for NtUserSetWindowDisplayAffinity
3. Validate hook integrity at runtime
4. Consider moving display protection to hypervisor level

### Proposed Patch

#### Conceptual Fix
```c
// Add integrity check in NtUserSetWindowDisplayAffinity
NTSTATUS NtUserSetWindowDisplayAffinity_Secure(HWND hwnd, DWORD dwFlags) {
    // Verify caller integrity
    if (!NT_SUCCESS(VerifyCallerIntegrity())) {
        return STATUS_ACCESS_DENIED;
    }

    // Validate flags haven't been tampered
    if (!ValidateDisplayAffinityFlags(dwFlags)) {
        LogSecurityEvent("Display affinity tampering detected");
        return STATUS_INVALID_PARAMETER;
    }

    // Proceed with original function
    return NtUserSetWindowDisplayAffinity_Original(hwnd, dwFlags);
}
```

### Testing Performed

| Test Case | Result |
|-----------|---------|
| Windows 10 22H2 | Vulnerable |
| Windows 11 23H2 | Vulnerable |
| With HVCI Enabled | Protected |
| With Secure Boot | Partial Protection |
| With EDR (Defender) | Detected but not blocked |

### Disclosure Timeline

- **[Date]:** Vulnerability discovered
- **[Date]:** Initial report to MSRC
- **[Date + 7 days]:** MSRC acknowledgment expected
- **[Date + 30 days]:** Microsoft validation complete
- **[Date + 90 days]:** Coordinated disclosure deadline
- **[Date + 120 days]:** Public disclosure (if no patch)

### References

1. Windows Kernel Programming - Pavel Yosifovich
2. MSRC Submission Guidelines
3. CVE-2019-1458 (Similar kernel bypass)
4. Windows Internals 7th Edition

### Contact Information

**Primary Researcher:** [Your Name]
**Email:** [Your Email]
**Organization:** [Your Organization]
**PGP Key:** [Optional]

### Attachments

1. Full source code (ZIP, password: msrc2024)
2. Compiled driver binary (for validation)
3. Video demonstration (MP4)
4. Test automation scripts

### Responsible Disclosure Statement

This vulnerability is being reported under responsible disclosure principles. We commit to:
- Not disclosing publicly before coordinated date
- Working with Microsoft on validation
- Providing additional information as needed
- Following MSRC disclosure guidelines

### Legal Declaration

I affirm that:
- This research was conducted legally on systems I own
- No unauthorized access occurred
- No production systems were affected
- All testing was within legal boundaries

---

**Submission Method:** https://msrc.microsoft.com/create-report
**Severity Assessment:** Medium (Admin required, but bypasses security feature)
**Recommended Priority:** Moderate (not remotely exploitable)